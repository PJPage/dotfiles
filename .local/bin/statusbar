#!/usr/bin/env sh

melonpanel_height=22
font='-misc-fixed-medium-r-normal--13-120-75-75-c-80-iso10646-1'
fontbold='-misc-fixed-bold-r-normal--13-120-75-75-c-80-iso10646-1'
bg_main="#000000"
fg_main="#ffffff"

_clock() {
    date +'%a %b %-d %H:%M'
}

_modules() {
    while true; do
        echo "$(_clock)"
        sleep 1s
    done
}

melonpanel_fifo='/tmp/melonpanel.fifo'
[ -e "$melonpanel_fifo" ] && rm "$melonpanel_fifo"
mkfifo "$melonpanel_fifo"

_modules > "$melonpanel_fifo" &
bspc subscribe report > "$melonpanel_fifo" &

_main() {
    while read -r line; do
        case $line in
            W*)
                wm="$line"
                ;;
            *)
                mods="$line"
                ;;
        esac
        echo "%{l}$wm%{r}$mods"
    done
}

_main < "$melonpanel_fifo" \
    | lemonbar -b -u 1 -p -g "x${melonpanel_height}" \
               -F "$fg_main" -B "#ff${bg_main:1}" \
               -f "$font" -n "Melonpanel"
